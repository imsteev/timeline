<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Timeline</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <!-- <link rel="manifest" href="/site.webmanifest"> -->
    <script crossorigin src="https://unpkg.com/react@16.13.1/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.9.6/babel.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <style type="text/css">

      html {
        overflow-x: hidden;
      }

      .form {
        display: table;
        position: absolute;
        top: 50vh;
        margin-left: 6rem;
      }

      .form > div {
        display: table-row;
        margin-top: 1rem;
      }

      .form button {
        border: solid black 1px;
        padding: 1rem;
        cursor: pointer;
        width: 100%;
        margin-top: 2rem;
      }

      .error {
        border: solid black 1px;
        width: 100%;
        color: red;
        text-align: center;
      }

      .form button:hover, .prev-year:hover, .next-year:hover {
        transition: all 0.1s;
        background-color: black;
        color: white;
        cursor: pointer;
      }

      .form > div > input, .form > div > span {
        display: table-cell;
        padding: 1rem;
        outline: none;
        border: none;
        font-size: 1.5rem;
      }

      .form > div > input:focus {
        border: solid  1px #C0C0C0;
        opacity: 0.8;
      }

      .notch {
        font-size: 4rem;
        color: red;
      }

      .timeline {
        position: absolute;
        display: flex;
        justify-content: space-between;
        margin-left: 2rem;
        width: 95%;
        text-transform: capitalize;
      }


      input::placeholder {
        font-size: 0.8rem;
        opacity: 0.6;
        margin-bottom: 1.2rem;
      }
      input {
        padding-left: 0.6rem;
      }

      .timeline .timeline-event {
        padding: 1rem;
      }

      .month {
        display: flex;
        flex-direction: column;
        margin: 1rem;
        align-items: center;
        flex: 1 1 0px;  /* make all flex items grow to the same proportion*/
        padding: 1rem;
        border: none;
        cursor: pointer;
      }

      .month:hover {
        border-bottom: solid lightgrey 3px;
      }

      .year-control {
        display: flex;
        margin-top: 10rem;
        justify-content: space-evenly;
      }

      .current-year {
        padding: 1rem;
      }

      .prev-year {
        padding: 1rem;
        border: solid black 1px;
      }

      .next-year {
        padding: 1rem;
        border: solid black 1px;
      }

      .current-month-true {
        border-bottom: solid grey 3px;
        font-weight: bold;
      }

      button {
        padding: 1rem;
        border: none;
        outline: none;
        cursor: pointer;
      }

      .events {
        position: absolute;
        top: 40%;
        left: 35%;
        width: 60vw;
        border-radius: 16px;
        padding: 2rem;
      }

    </style>
  </head>
  <body>
    <div id="root"></div>
      <script type="text/babel">
        Date.prototype.monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
        ];

        Date.prototype.getMonthName = function() {
            return this.monthNames[this.getMonth()];
        };

        const timelineEvents = [];

        const createTimelineEvent = (title, description = '', start = '', end = '') => {
          const data = {
            title,
            description,
            start,
            end
          }
          console.log(4)
          fetch(`${API_URL}/api/timeline_events`, {
            method: 'post',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            }
          })
          return data
        }

        const TimelineEvent = ({ e }) => {
          return <div className="timeline-event">
            <h3>{e.title}</h3>
            <p>{e.description}</p>
            {e.start && <span>Start: {e.start}</span>}
            {e.end && <span>End: {e.end}</span>}
          </div>
        }

        const API_URL = 'http://127.0.0.1:5000'

        const App = () => {
          const today = new Date();
          const [title, setTitle] = React.useState('');
          const [description, setDescription] = React.useState('');
          const [start, setStart] = React.useState(today.toLocaleDateString().slice(0, 10));
          const [end, setEnd] = React.useState('');

          const [submitted, setSubmitted] = React.useState(false)

          const [currentYear, setCurrentYear] = React.useState(today.getFullYear())
          const [currentMonth, setCurrentMonth] = React.useState(new Date(start).getMonth());

          const [experiencesByMonth, setExperiencesByMonth] = React.useState({});

          const [error, setError] = React.useState('');

          const titleRef = React.useRef(null);

          const months = [0, 1, 2, 3, 4, 5, 6,7, 8, 9, 10, 11];

          React.useEffect(() => {
            console.log('hello')
            if (titleRef && titleRef.current) {
              console.log('focusing');
              titleRef.current.focus();
            }
          }, [titleRef]);

          React.useEffect(() => {
            if (submitted) {
              setTitle('');
              setDescription('');
              setStart(today.toLocaleDateString().slice(0, 10));
              setEnd('');
              setSubmitted(false);
            }
          }, [submitted])

          React.useEffect(() => {
            const date = new Date(start);
            const month = date.getMonth();
            const year = date.getFullYear();
            setCurrentMonth(date.getMonth());
            setCurrentYear(year === NaN ? '-' : year);
          }, [start])

          React.useEffect(() => {
            fetch(`${API_URL}/api/timeline_events`)
              .then(resp => {
                if (resp.status === 200) {
                  return resp.json()
                }
              })
              .then(console.log)
              .catch(console.log)
          }, [])

          const onClick = () => {
            const newEvent = createTimelineEvent(title, description, start, end);
            if (!newEvent.title) {
              setError('Please input a title')
              return;
            }
            if (!newEvent.start) {
              setError('Please enter a start month');
              return;
            }
            setError('');
            timelineEvents.push(newEvent)
            const date = new Date(start)
            const key = `${date.getMonth()}/${currentYear}`;
            if (!(key in experiencesByMonth)) {
              experiencesByMonth[key] = []
            }
            experiencesByMonth[key].push(newEvent)
            setSubmitted(true);
          }

          const selectMonth = (month) => {
            if (currentMonth !== month) {
              setCurrentMonth(month)
            }
          }

          return <>
            <h1 style={{ position: 'relative', left: '80%', fontSize: '3rem', color: 'forestgreen' }}>Timeline</h1>
            <div>
              <div className="timeline">
                {months.map(month => {
                  const date = new Date()
                  date.setMonth(month % 12)
                  const numExperiences = (experiencesByMonth[`${month}/${currentYear}`] || []).length
                  return <div className={`month current-month-${month === currentMonth}`} onClick={() => selectMonth(month)}>
                    <button key={month}>
                      {date.getMonthName()}
                    </button>
                    <span style={{ color: 'orange' }}>{numExperiences}</span>
                  </div>
                })}
              </div>
            </div>
            <div className="year-control">
              <h2 className="prev-year" onClick={() => setCurrentYear(currentYear - 1)}>Previous</h2>
              <h2 className="current-year" style={{ textAlign: 'center', marginTop: ''}}>{currentYear}</h2>
              <h2 className="next-year" onClick={() => setCurrentYear(currentYear + 1)}>Next</h2>
            </div>
            <div className="form" onKeyDown={e => e.keyCode === 13 ? onClick() : null}>
              <div>
                <span>Title:</span>
                <input autoFocus
                  autoComplete="off"
                  placeholder="Short title of an experience"
                  type="text"
                  name="title"
                  value={title}
                  onChange={e => setTitle(e.target.value)}
                />
              </div>
              <div>
                <span>Description:</span>
                <input
                  autoComplete="off"
                  placeholder="Any details?"
                  type="text"
                  name="description"
                  value={description}
                  onChange={e => setDescription(e.target.value)}
              />
              </div>
              <div>
                <span>Start date:</span>
                <input
                  autoComplete="off"
                  placeholder="MM/DD/YYYY"
                  type="text"
                  name="start"
                  value={start}
                  onChange={e => setStart(e.target.value)}
                />
              </div>
              <div>
                <span>End date:</span>
                <input
                  autoComplete="off"
                  placeholder="MM/DD/YYYY"
                  type="text"
                  name="end"
                  value={end}
                  onChange={e => setEnd(e.target.value)}
               />
              </div>
              <button onClick={onClick}>Create New</button>
              {error && <div className="error">{error}</div>}
            </div>
            <ul className="events">
              <div style={{ marginBottom: '3rem' }}>{start}</div>
              {(experiencesByMonth[`${currentMonth}/${currentYear}`] || [])
                  .map(t => <li>
                    <span>{t.title} ({new Date(t.start).toLocaleDateString().slice(0, 10)})</span>
                    <span style={{ marginLeft: '2rem', color: 'orange' }}>{t.description}</span>
                  </li>)
              }
            </ul>
          </>
        }

        ReactDOM.render(<App />, document.getElementById('root'))
      </script>
  </body>
</html>